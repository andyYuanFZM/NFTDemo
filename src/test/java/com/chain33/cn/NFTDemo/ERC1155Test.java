package com.chain33.cn.NFTDemo;

import java.io.IOException;
import java.util.List;

import org.junit.Test;
import com.alibaba.fastjson.JSONObject;
import cn.chain33.javasdk.client.Account;
import cn.chain33.javasdk.client.RpcClient;
import cn.chain33.javasdk.model.AccountInfo;
import cn.chain33.javasdk.model.decode.DecodeRawTransaction;
import cn.chain33.javasdk.model.rpcresult.QueryTransactionResult;
import cn.chain33.javasdk.utils.ByteUtil;
import cn.chain33.javasdk.utils.EvmUtil;
import cn.chain33.javasdk.utils.HexUtil;
import cn.chain33.javasdk.utils.TransactionUtil;

/**
 * NFT ERC1155 发行和转让
 *
 */
public class ERC1155Test {

	// 平行链所在服务器IP地址
	String ip = "172.22.17.225";
	// 平行链服务端口
	int port = 8901;
	RpcClient client = new RpcClient(ip, port);
	
    // 平行链名称，固定格式user.p.xxxx.样例中使用的名称叫mbaas， 根据自己平行链名称变化。  这个名称一定要和平行链配置文件中的名称完全一致。
	String paraName = "user.p.mbaas.";

	// 合约部署人（管理员）地址和私钥,地址下需要有BTY来缴纳手续费
	// 生成方式参考下面testCreateAccount方法，私钥和地址一一对应
	String managerAddress = "1AKAm9vV6m4TbTzHKwirdygakF5HNus8Bg";
    String managerPrivateKey = "65f879c5a5d305b1710c7f46f1d027f4f2bf3c05d09178aa5b057d73b4cc54ca";
    
    // 用户手续费代扣地址和私钥,地址下需要有BTY来缴纳手续费
	// 生成方式参考下面testCreateAccount方法，私钥和地址一一对应
	String withholdAddress = "1L26eqrBgZanXqosSLrzM9ad77B6KwYZov";
    String withholdPrivateKey = "720093b1563200b6f30105d13198d262b91f31ae49616c947fe9cb5658bdd0ff";
    
    // 用户A地址和私钥
	String useraAddress;
    String useraPrivateKey;
    
    // 用户B地址和私钥
	String userbAddress;
    String userbPrivateKey;
    
    // solidity合约源码见：./solidity/ERC1155.sol
    // 合约编译出来的bytecode
    String codes = "60806040526040518060400160405280600381526020017f2d2d3e0000000000000000000000000000000000000000000000000000000000815250600390805190602001906200005192919062000181565b506040518060400160405280600181526020017f2800000000000000000000000000000000000000000000000000000000000000815250600490805190602001906200009f92919062000181565b506040518060400160405280600181526020017f290000000000000000000000000000000000000000000000000000000000000081525060059080519060200190620000ed92919062000181565b50348015620000fb57600080fd5b50604051806020016040528060008152506200011d816200016560201b60201c565b5033600660006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555062000296565b80600290805190602001906200017d92919062000181565b5050565b8280546200018f9062000231565b90600052602060002090601f016020900481019282620001b35760008555620001ff565b82601f10620001ce57805160ff1916838001178555620001ff565b82800160010185558215620001ff579182015b82811115620001fe578251825591602001919060010190620001e1565b5b5090506200020e919062000212565b5090565b5b808211156200022d57600081600090555060010162000213565b5090565b600060028204905060018216806200024a57607f821691505b6020821081141562000261576200026062000267565b5b50919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052602260045260246000fd5b61363680620002a66000396000f3fe608060405234801561001057600080fd5b50600436106100b35760003560e01c80639727756a116100715780639727756a146101b0578063a22cb465146101cc578063b2bdfa7b146101e8578063d8b7c04814610206578063e985e9c514610236578063f242432a14610266576100b3565b8062fdd58e146100b857806301ffc9a7146100e85780630e89341c146101185780630f2ad370146101485780632eb2c2d6146101645780634e1273f414610180575b600080fd5b6100d260048036038101906100cd91906124db565b610282565b6040516100df9190612fe1565b60405180910390f35b61010260048036038101906100fd91906125fe565b61034b565b60405161010f9190612e24565b60405180910390f35b610132600480360381019061012d9190612691565b61042d565b60405161013f9190612e3f565b60405180910390f35b610162600480360381019061015d9190612517565b6104c1565b005b61017e600480360381019061017991906122d2565b6107aa565b005b61019a60048036038101906101959190612592565b61084b565b6040516101a79190612dcb565b60405180910390f35b6101ca60048036038101906101c59190612420565b6109fc565b005b6101e660048036038101906101e1919061249f565b610aac565b005b6101f0610ac2565b6040516101fd9190612cee565b60405180910390f35b610220600480360381019061021b9190612650565b610ae8565b60405161022d9190612e3f565b60405180910390f35b610250600480360381019061024b9190612296565b610b98565b60405161025d9190612e24565b60405180910390f35b610280600480360381019061027b9190612391565b610c2c565b005b60008073ffffffffffffffffffffffffffffffffffffffff168373ffffffffffffffffffffffffffffffffffffffff1614156102f3576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016102ea90612ea1565b60405180910390fd5b60008083815260200190815260200160002060008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002054905092915050565b60007fd9b67a26000000000000000000000000000000000000000000000000000000007bffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916827bffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916148061041657507f0e89341c000000000000000000000000000000000000000000000000000000007bffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916827bffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916145b80610426575061042582610ccd565b5b9050919050565b60606002805461043c90613399565b80601f016020809104026020016040519081016040528092919081815260200182805461046890613399565b80156104b55780601f1061048a576101008083540402835291602001916104b5565b820191906000526020600020905b81548152906001019060200180831161049857829003601f168201915b50505050509050919050565b6104dd3385858560405180602001604052806000815250610c2c565b60006104e884610d37565b905060006007826040516104fc9190612cd7565b9081526020016040518091039020805461051590613399565b80601f016020809104026020016040519081016040528092919081815260200182805461054190613399565b801561058e5780601f106105635761010080835404028352916020019161058e565b820191906000526020600020905b81548152906001019060200180831161057157829003601f168201915b50505050509050600061062b82600380546105a890613399565b80601f01602080910402602001604051908101604052809291908181526020018280546105d490613399565b80156106215780601f106105f657610100808354040283529160200191610621565b820191906000526020600020905b81548152906001019060200180831161060457829003601f168201915b5050505050610f0c565b905060006106c3826004805461064090613399565b80601f016020809104026020016040519081016040528092919081815260200182805461066c90613399565b80156106b95780601f1061068e576101008083540402835291602001916106b9565b820191906000526020600020905b81548152906001019060200180831161069c57829003601f168201915b5050505050610f0c565b905060006106d18287610f0c565b9050600061076982600580546106e690613399565b80601f016020809104026020016040519081016040528092919081815260200182805461071290613399565b801561075f5780601f106107345761010080835404028352916020019161075f565b820191906000526020600020905b81548152906001019060200180831161074257829003601f168201915b5050505050610f0c565b90508060078760405161077c9190612cd7565b9081526020016040518091039020908051906020019061079d929190611f8e565b5050505050505050505050565b6107b261114c565b73ffffffffffffffffffffffffffffffffffffffff168573ffffffffffffffffffffffffffffffffffffffff1614806107f857506107f7856107f261114c565b610b98565b5b610837576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161082e90612f21565b60405180910390fd5b6108448585858585611154565b5050505050565b60608151835114610891576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161088890612f81565b60405180910390fd5b6000835167ffffffffffffffff8111156108d4577f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b6040519080825280602002602001820160405280156109025781602001602082028036833780820191505090505b50905060005b84518110156109f15761099b85828151811061094d577f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b602002602001015185838151811061098e577f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b6020026020010151610282565b8282815181106109d4577f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b602002602001018181525050806109ea906133cb565b9050610908565b508091505092915050565b600660009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff1614610a8c576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610a8390612ee1565b60405180910390fd5b610aa7838383604051806020016040528060008152506114b4565b505050565b610abe610ab761114c565b838361171e565b5050565b600660009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b6060600782604051610afa9190612cd7565b90815260200160405180910390208054610b1390613399565b80601f0160208091040260200160405190810160405280929190818152602001828054610b3f90613399565b8015610b8c5780601f10610b6157610100808354040283529160200191610b8c565b820191906000526020600020905b815481529060010190602001808311610b6f57829003601f168201915b50505050509050919050565b6000600160008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060009054906101000a900460ff16905092915050565b610c3461114c565b73ffffffffffffffffffffffffffffffffffffffff168573ffffffffffffffffffffffffffffffffffffffff161480610c7a5750610c7985610c7461114c565b610b98565b5b610cb9576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610cb090612ec1565b60405180910390fd5b610cc6858585858561188b565b5050505050565b60007f01ffc9a7000000000000000000000000000000000000000000000000000000007bffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916827bffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916149050919050565b60606000821415610d7f576040518060400160405280600181526020017f30000000000000000000000000000000000000000000000000000000000000008152509050610f07565b600082905060005b60008214610db1578080610d9a906133cb565b915050600a82610daa9190613217565b9150610d87565b60008167ffffffffffffffff811115610df3577f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b6040519080825280601f01601f191660200182016040528015610e255781602001600182028036833780820191505090505b50905060008290505b60008614610eff57600181610e4391906132a2565b90506000600a8088610e559190613217565b610e5f9190613248565b87610e6a91906132a2565b6030610e7691906131e0565b905060008160f81b905080848481518110610eba577f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b60200101907effffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916908160001a905350600a88610ef69190613217565b97505050610e2e565b819450505050505b919050565b606060008390506000839050600081518351610f28919061318a565b67ffffffffffffffff811115610f67577f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b6040519080825280601f01601f191660200182016040528015610f995781602001600182028036833780820191505090505b50905060005b835181101561106757838181518110610fe1577f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b602001015160f81c60f81b828281518110611025577f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b60200101907effffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916908160001a905350808061105f906133cb565b915050610f9f565b5060005b825181101561113f578281815181106110ad577f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b602001015160f81c60f81b828286516110c6919061318a565b815181106110fd577f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b60200101907effffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916908160001a9053508080611137906133cb565b91505061106b565b5080935050505092915050565b600033905090565b8151835114611198576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161118f90612fa1565b60405180910390fd5b600073ffffffffffffffffffffffffffffffffffffffff168473ffffffffffffffffffffffffffffffffffffffff161415611208576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016111ff90612f01565b60405180910390fd5b600061121261114c565b9050611222818787878787611b0d565b60005b845181101561141f576000858281518110611269577f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b6020026020010151905060008583815181106112ae577f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b60200260200101519050600080600084815260200190815260200160002060008b73ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000205490508181101561134f576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161134690612f41565b60405180910390fd5b81810360008085815260200190815260200160002060008c73ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020819055508160008085815260200190815260200160002060008b73ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000206000828254611404919061318a565b9250508190555050505080611418906133cb565b9050611225565b508473ffffffffffffffffffffffffffffffffffffffff168673ffffffffffffffffffffffffffffffffffffffff168273ffffffffffffffffffffffffffffffffffffffff167f4a39dc06d4c0dbc64b70af90fd698a233a518aa5d07e595d983b8c0526c8f7fb8787604051611496929190612ded565b60405180910390a46114ac818787878787611b15565b505050505050565b600073ffffffffffffffffffffffffffffffffffffffff168473ffffffffffffffffffffffffffffffffffffffff161415611524576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161151b90612fc1565b60405180910390fd5b8151835114611568576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161155f90612fa1565b60405180910390fd5b600061157261114c565b905061158381600087878787611b0d565b60005b8451811015611688578381815181106115c8577f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b602002602001015160008087848151811061160c577f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b6020026020010151815260200190815260200160002060008873ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600082825461166e919061318a565b925050819055508080611680906133cb565b915050611586565b508473ffffffffffffffffffffffffffffffffffffffff16600073ffffffffffffffffffffffffffffffffffffffff168273ffffffffffffffffffffffffffffffffffffffff167f4a39dc06d4c0dbc64b70af90fd698a233a518aa5d07e595d983b8c0526c8f7fb8787604051611700929190612ded565b60405180910390a461171781600087878787611b15565b5050505050565b8173ffffffffffffffffffffffffffffffffffffffff168373ffffffffffffffffffffffffffffffffffffffff16141561178d576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161178490612f61565b60405180910390fd5b80600160008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060006101000a81548160ff0219169083151502179055508173ffffffffffffffffffffffffffffffffffffffff168373ffffffffffffffffffffffffffffffffffffffff167f17307eab39ab6107e8899845ad3d59bd9653f200f220920489ca2b5937696c318360405161187e9190612e24565b60405180910390a3505050565b600073ffffffffffffffffffffffffffffffffffffffff168473ffffffffffffffffffffffffffffffffffffffff1614156118fb576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016118f290612f01565b60405180910390fd5b600061190561114c565b905061192581878761191688611ce5565b61191f88611ce5565b87611b0d565b600080600086815260200190815260200160002060008873ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020549050838110156119bc576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016119b390612f41565b60405180910390fd5b83810360008087815260200190815260200160002060008973ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020819055508360008087815260200190815260200160002060008873ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000206000828254611a71919061318a565b925050819055508573ffffffffffffffffffffffffffffffffffffffff168773ffffffffffffffffffffffffffffffffffffffff168373ffffffffffffffffffffffffffffffffffffffff167fc3d58168c5ae7397731d063d5bbf3d657854427343f4c083240f7aacaa2d0f628888604051611aee929190612ffc565b60405180910390a4611b04828888888888611dab565b50505050505050565b505050505050565b611b348473ffffffffffffffffffffffffffffffffffffffff16611f7b565b15611cdd578373ffffffffffffffffffffffffffffffffffffffff1663bc197c8187878686866040518663ffffffff1660e01b8152600401611b7a959493929190612d09565b602060405180830381600087803b158015611b9457600080fd5b505af1925050508015611bc557506040513d601f19601f82011682018060405250810190611bc29190612627565b60015b611c5457611bd16134ee565b80611bdc5750611c19565b806040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401611c109190612e3f565b60405180910390fd5b6040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401611c4b90612e61565b60405180910390fd5b63bc197c8160e01b7bffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916817bffffffffffffffffffffffffffffffffffffffffffffffffffffffff191614611cdb576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401611cd290612e81565b60405180910390fd5b505b505050505050565b60606000600167ffffffffffffffff811115611d2a577f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b604051908082528060200260200182016040528015611d585781602001602082028036833780820191505090505b5090508281600081518110611d96577f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b60200260200101818152505080915050919050565b611dca8473ffffffffffffffffffffffffffffffffffffffff16611f7b565b15611f73578373ffffffffffffffffffffffffffffffffffffffff1663f23a6e6187878686866040518663ffffffff1660e01b8152600401611e10959493929190612d71565b602060405180830381600087803b158015611e2a57600080fd5b505af1925050508015611e5b57506040513d601f19601f82011682018060405250810190611e589190612627565b60015b611eea57611e676134ee565b80611e725750611eaf565b806040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401611ea69190612e3f565b60405180910390fd5b6040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401611ee190612e61565b60405180910390fd5b63f23a6e6160e01b7bffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916817bffffffffffffffffffffffffffffffffffffffffffffffffffffffff191614611f71576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401611f6890612e81565b60405180910390fd5b505b505050505050565b600080823b905060008111915050919050565b828054611f9a90613399565b90600052602060002090601f016020900481019282611fbc5760008555612003565b82601f10611fd557805160ff1916838001178555612003565b82800160010185558215612003579182015b82811115612002578251825591602001919060010190611fe7565b5b5090506120109190612014565b5090565b5b8082111561202d576000816000905550600101612015565b5090565b600061204461203f84613056565b613025565b9050808382526020820190508285602086028201111561206357600080fd5b60005b8581101561209357816120798882612185565b845260208401935060208301925050600181019050612066565b5050509392505050565b60006120b06120ab84613082565b613025565b905080838252602082019050828560208602820111156120cf57600080fd5b60005b858110156120ff57816120e58882612281565b8452602084019350602083019250506001810190506120d2565b5050509392505050565b600061211c612117846130ae565b613025565b90508281526020810184848401111561213457600080fd5b61213f848285613357565b509392505050565b600061215a612155846130de565b613025565b90508281526020810184848401111561217257600080fd5b61217d848285613357565b509392505050565b600081359050612194816135a4565b92915050565b600082601f8301126121ab57600080fd5b81356121bb848260208601612031565b91505092915050565b600082601f8301126121d557600080fd5b81356121e584826020860161209d565b91505092915050565b6000813590506121fd816135bb565b92915050565b600081359050612212816135d2565b92915050565b600081519050612227816135d2565b92915050565b600082601f83011261223e57600080fd5b813561224e848260208601612109565b91505092915050565b600082601f83011261226857600080fd5b8135612278848260208601612147565b91505092915050565b600081359050612290816135e9565b92915050565b600080604083850312156122a957600080fd5b60006122b785828601612185565b92505060206122c885828601612185565b9150509250929050565b600080600080600060a086880312156122ea57600080fd5b60006122f888828901612185565b955050602061230988828901612185565b945050604086013567ffffffffffffffff81111561232657600080fd5b612332888289016121c4565b935050606086013567ffffffffffffffff81111561234f57600080fd5b61235b888289016121c4565b925050608086013567ffffffffffffffff81111561237857600080fd5b6123848882890161222d565b9150509295509295909350565b600080600080600060a086880312156123a957600080fd5b60006123b788828901612185565b95505060206123c888828901612185565b94505060406123d988828901612281565b93505060606123ea88828901612281565b925050608086013567ffffffffffffffff81111561240757600080fd5b6124138882890161222d565b9150509295509295909350565b60008060006060848603121561243557600080fd5b600061244386828701612185565b935050602084013567ffffffffffffffff81111561246057600080fd5b61246c868287016121c4565b925050604084013567ffffffffffffffff81111561248957600080fd5b612495868287016121c4565b9150509250925092565b600080604083850312156124b257600080fd5b60006124c085828601612185565b92505060206124d1858286016121ee565b9150509250929050565b600080604083850312156124ee57600080fd5b60006124fc85828601612185565b925050602061250d85828601612281565b9150509250929050565b6000806000806080858703121561252d57600080fd5b600061253b87828801612185565b945050602061254c87828801612281565b935050604061255d87828801612281565b925050606085013567ffffffffffffffff81111561257a57600080fd5b61258687828801612257565b91505092959194509250565b600080604083850312156125a557600080fd5b600083013567ffffffffffffffff8111156125bf57600080fd5b6125cb8582860161219a565b925050602083013567ffffffffffffffff8111156125e857600080fd5b6125f4858286016121c4565b9150509250929050565b60006020828403121561261057600080fd5b600061261e84828501612203565b91505092915050565b60006020828403121561263957600080fd5b600061264784828501612218565b91505092915050565b60006020828403121561266257600080fd5b600082013567ffffffffffffffff81111561267c57600080fd5b61268884828501612257565b91505092915050565b6000602082840312156126a357600080fd5b60006126b184828501612281565b91505092915050565b60006126c68383612cb9565b60208301905092915050565b6126db816132d6565b82525050565b60006126ec8261311e565b6126f6818561314c565b93506127018361310e565b8060005b8381101561273257815161271988826126ba565b97506127248361313f565b925050600181019050612705565b5085935050505092915050565b612748816132e8565b82525050565b600061275982613129565b612763818561315d565b9350612773818560208601613366565b61277c816134d0565b840191505092915050565b600061279282613134565b61279c818561316e565b93506127ac818560208601613366565b6127b5816134d0565b840191505092915050565b60006127cb82613134565b6127d5818561317f565b93506127e5818560208601613366565b80840191505092915050565b60006127fe60348361316e565b91507f455243313135353a207472616e7366657220746f206e6f6e204552433131353560008301527f526563656976657220696d706c656d656e7465720000000000000000000000006020830152604082019050919050565b600061286460288361316e565b91507f455243313135353a204552433131353552656365697665722072656a6563746560008301527f6420746f6b656e730000000000000000000000000000000000000000000000006020830152604082019050919050565b60006128ca602b8361316e565b91507f455243313135353a2062616c616e636520717565727920666f7220746865207a60008301527f65726f20616464726573730000000000000000000000000000000000000000006020830152604082019050919050565b600061293060298361316e565b91507f455243313135353a2063616c6c6572206973206e6f74206f776e6572206e6f7260008301527f20617070726f76656400000000000000000000000000000000000000000000006020830152604082019050919050565b600061299660268361316e565b91507f6f6e6c7920617574686f72697a6564206f776e65722063616e2073746f72652060008301527f66696c65732e00000000000000000000000000000000000000000000000000006020830152604082019050919050565b60006129fc60258361316e565b91507f455243313135353a207472616e7366657220746f20746865207a65726f20616460008301527f64726573730000000000000000000000000000000000000000000000000000006020830152604082019050919050565b6000612a6260328361316e565b91507f455243313135353a207472616e736665722063616c6c6572206973206e6f742060008301527f6f776e6572206e6f7220617070726f76656400000000000000000000000000006020830152604082019050919050565b6000612ac8602a8361316e565b91507f455243313135353a20696e73756666696369656e742062616c616e636520666f60008301527f72207472616e73666572000000000000000000000000000000000000000000006020830152604082019050919050565b6000612b2e60298361316e565b91507f455243313135353a2073657474696e6720617070726f76616c2073746174757360008301527f20666f722073656c6600000000000000000000000000000000000000000000006020830152604082019050919050565b6000612b9460298361316e565b91507f455243313135353a206163636f756e747320616e6420696473206c656e67746860008301527f206d69736d6174636800000000000000000000000000000000000000000000006020830152604082019050919050565b6000612bfa60288361316e565b91507f455243313135353a2069647320616e6420616d6f756e7473206c656e6774682060008301527f6d69736d617463680000000000000000000000000000000000000000000000006020830152604082019050919050565b6000612c6060218361316e565b91507f455243313135353a206d696e7420746f20746865207a65726f2061646472657360008301527f73000000000000000000000000000000000000000000000000000000000000006020830152604082019050919050565b612cc281613340565b82525050565b612cd181613340565b82525050565b6000612ce382846127c0565b915081905092915050565b6000602082019050612d0360008301846126d2565b92915050565b600060a082019050612d1e60008301886126d2565b612d2b60208301876126d2565b8181036040830152612d3d81866126e1565b90508181036060830152612d5181856126e1565b90508181036080830152612d65818461274e565b90509695505050505050565b600060a082019050612d8660008301886126d2565b612d9360208301876126d2565b612da06040830186612cc8565b612dad6060830185612cc8565b8181036080830152612dbf818461274e565b90509695505050505050565b60006020820190508181036000830152612de581846126e1565b905092915050565b60006040820190508181036000830152612e0781856126e1565b90508181036020830152612e1b81846126e1565b90509392505050565b6000602082019050612e39600083018461273f565b92915050565b60006020820190508181036000830152612e598184612787565b905092915050565b60006020820190508181036000830152612e7a816127f1565b9050919050565b60006020820190508181036000830152612e9a81612857565b9050919050565b60006020820190508181036000830152612eba816128bd565b9050919050565b60006020820190508181036000830152612eda81612923565b9050919050565b60006020820190508181036000830152612efa81612989565b9050919050565b60006020820190508181036000830152612f1a816129ef565b9050919050565b60006020820190508181036000830152612f3a81612a55565b9050919050565b60006020820190508181036000830152612f5a81612abb565b9050919050565b60006020820190508181036000830152612f7a81612b21565b9050919050565b60006020820190508181036000830152612f9a81612b87565b9050919050565b60006020820190508181036000830152612fba81612bed565b9050919050565b60006020820190508181036000830152612fda81612c53565b9050919050565b6000602082019050612ff66000830184612cc8565b92915050565b60006040820190506130116000830185612cc8565b61301e6020830184612cc8565b9392505050565b6000604051905081810181811067ffffffffffffffff8211171561304c5761304b6134a1565b5b8060405250919050565b600067ffffffffffffffff821115613071576130706134a1565b5b602082029050602081019050919050565b600067ffffffffffffffff82111561309d5761309c6134a1565b5b602082029050602081019050919050565b600067ffffffffffffffff8211156130c9576130c86134a1565b5b601f19601f8301169050602081019050919050565b600067ffffffffffffffff8211156130f9576130f86134a1565b5b601f19601f8301169050602081019050919050565b6000819050602082019050919050565b600081519050919050565b600081519050919050565b600081519050919050565b6000602082019050919050565b600082825260208201905092915050565b600082825260208201905092915050565b600082825260208201905092915050565b600081905092915050565b600061319582613340565b91506131a083613340565b9250827fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff038211156131d5576131d4613414565b5b828201905092915050565b60006131eb8261334a565b91506131f68361334a565b92508260ff0382111561320c5761320b613414565b5b828201905092915050565b600061322282613340565b915061322d83613340565b92508261323d5761323c613443565b5b828204905092915050565b600061325382613340565b915061325e83613340565b9250817fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff048311821515161561329757613296613414565b5b828202905092915050565b60006132ad82613340565b91506132b883613340565b9250828210156132cb576132ca613414565b5b828203905092915050565b60006132e182613320565b9050919050565b60008115159050919050565b60007fffffffff0000000000000000000000000000000000000000000000000000000082169050919050565b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b6000819050919050565b600060ff82169050919050565b82818337600083830152505050565b60005b83811015613384578082015181840152602081019050613369565b83811115613393576000848401525b50505050565b600060028204905060018216806133b157607f821691505b602082108114156133c5576133c4613472565b5b50919050565b60006133d682613340565b91507fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff82141561340957613408613414565b5b600182019050919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601160045260246000fd5b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601260045260246000fd5b7f4e487b7100000000000000000000000000000000000000000000000000000000600052602260045260246000fd5b7f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b6000601f19601f8301169050919050565b60008160e01c9050919050565b600060443d10156134fe576135a1565b60046000803e61350f6000516134e1565b6308c379a0811461352057506135a1565b60405160043d036004823e80513d602482011167ffffffffffffffff8211171561354c575050506135a1565b808201805167ffffffffffffffff81111561356b5750505050506135a1565b8060208301013d8501811115613586575050505050506135a1565b61358f826134d0565b60208401016040528296505050505050505b90565b6135ad816132d6565b81146135b857600080fd5b50565b6135c4816132e8565b81146135cf57600080fd5b50565b6135db816132f4565b81146135e657600080fd5b50565b6135f281613340565b81146135fd57600080fd5b5056fea2646970667358221220d2c66912713b3a11ad1fa78b20836b941142a84bfa50fc0da30134c59e5e978064736f6c63430008000033";
    // 合约对应的abi
    String abi = "[{\"inputs\": [],\"stateMutability\": \"nonpayable\",\"type\": \"constructor\"},{\"anonymous\": false,\"inputs\": [{\"indexed\": true,\"internalType\": \"address\",\"name\": \"account\",\"type\": \"address\"},{\"indexed\": true,\"internalType\": \"address\",\"name\": \"operator\",\"type\": \"address\"},{\"indexed\": false,\"internalType\": \"bool\",\"name\": \"approved\",\"type\": \"bool\"}],\"name\": \"ApprovalForAll\",\"type\": \"event\"},{\"anonymous\": false,\"inputs\": [{\"indexed\": true,\"internalType\": \"address\",\"name\": \"operator\",\"type\": \"address\"},{\"indexed\": true,\"internalType\": \"address\",\"name\": \"from\",\"type\": \"address\"},{\"indexed\": true,\"internalType\": \"address\",\"name\": \"to\",\"type\": \"address\"},{\"indexed\": false,\"internalType\": \"uint256[]\",\"name\": \"ids\",\"type\": \"uint256[]\"},{\"indexed\": false,\"internalType\": \"uint256[]\",\"name\": \"values\",\"type\": \"uint256[]\"}],\"name\": \"TransferBatch\",\"type\": \"event\"},{\"anonymous\": false,\"inputs\": [{\"indexed\": true,\"internalType\": \"address\",\"name\": \"operator\",\"type\": \"address\"},{\"indexed\": true,\"internalType\": \"address\",\"name\": \"from\",\"type\": \"address\"},{\"indexed\": true,\"internalType\": \"address\",\"name\": \"to\",\"type\": \"address\"},{\"indexed\": false,\"internalType\": \"uint256\",\"name\": \"id\",\"type\": \"uint256\"},{\"indexed\": false,\"internalType\": \"uint256\",\"name\": \"value\",\"type\": \"uint256\"}],\"name\": \"TransferSingle\",\"type\": \"event\"},{\"anonymous\": false,\"inputs\": [{\"indexed\": false,\"internalType\": \"string\",\"name\": \"value\",\"type\": \"string\"},{\"indexed\": true,\"internalType\": \"uint256\",\"name\": \"id\",\"type\": \"uint256\"}],\"name\": \"URI\",\"type\": \"event\"},{\"inputs\": [],\"name\": \"_owner\",\"outputs\": [{\"internalType\": \"address\",\"name\": \"\",\"type\": \"address\"}],\"stateMutability\": \"view\",\"type\": \"function\"},{\"inputs\": [{\"internalType\": \"address\",\"name\": \"account\",\"type\": \"address\"},{\"internalType\": \"uint256\",\"name\": \"id\",\"type\": \"uint256\"}],\"name\": \"balanceOf\",\"outputs\": [{\"internalType\": \"uint256\",\"name\": \"\",\"type\": \"uint256\"}],\"stateMutability\": \"view\",\"type\": \"function\"},{\"inputs\": [{\"internalType\": \"address[]\",\"name\": \"accounts\",\"type\": \"address[]\"},{\"internalType\": \"uint256[]\",\"name\": \"ids\",\"type\": \"uint256[]\"}],\"name\": \"balanceOfBatch\",\"outputs\": [{\"internalType\": \"uint256[]\",\"name\": \"\",\"type\": \"uint256[]\"}],\"stateMutability\": \"view\",\"type\": \"function\"},{\"inputs\": [{\"internalType\": \"string\",\"name\": \"id\",\"type\": \"string\"}],\"name\": \"getNFTTrace\",\"outputs\": [{\"internalType\": \"string\",\"name\": \"\",\"type\": \"string\"}],\"stateMutability\": \"view\",\"type\": \"function\"},{\"inputs\": [{\"internalType\": \"address\",\"name\": \"account\",\"type\": \"address\"},{\"internalType\": \"address\",\"name\": \"operator\",\"type\": \"address\"}],\"name\": \"isApprovedForAll\",\"outputs\": [{\"internalType\": \"bool\",\"name\": \"\",\"type\": \"bool\"}],\"stateMutability\": \"view\",\"type\": \"function\"},{\"inputs\": [{\"internalType\": \"address\",\"name\": \"_to\",\"type\": \"address\"},{\"internalType\": \"uint256[]\",\"name\": \"ids\",\"type\": \"uint256[]\"},{\"internalType\": \"uint256[]\",\"name\": \"amounts\",\"type\": \"uint256[]\"}],\"name\": \"mint\",\"outputs\": [],\"stateMutability\": \"nonpayable\",\"type\": \"function\"},{\"inputs\": [{\"internalType\": \"address\",\"name\": \"from\",\"type\": \"address\"},{\"internalType\": \"address\",\"name\": \"to\",\"type\": \"address\"},{\"internalType\": \"uint256[]\",\"name\": \"ids\",\"type\": \"uint256[]\"},{\"internalType\": \"uint256[]\",\"name\": \"amounts\",\"type\": \"uint256[]\"},{\"internalType\": \"bytes\",\"name\": \"data\",\"type\": \"bytes\"}],\"name\": \"safeBatchTransferFrom\",\"outputs\": [],\"stateMutability\": \"nonpayable\",\"type\": \"function\"},{\"inputs\": [{\"internalType\": \"address\",\"name\": \"from\",\"type\": \"address\"},{\"internalType\": \"address\",\"name\": \"to\",\"type\": \"address\"},{\"internalType\": \"uint256\",\"name\": \"id\",\"type\": \"uint256\"},{\"internalType\": \"uint256\",\"name\": \"amount\",\"type\": \"uint256\"},{\"internalType\": \"bytes\",\"name\": \"data\",\"type\": \"bytes\"}],\"name\": \"safeTransferFrom\",\"outputs\": [],\"stateMutability\": \"nonpayable\",\"type\": \"function\"},{\"inputs\": [{\"internalType\": \"address\",\"name\": \"operator\",\"type\": \"address\"},{\"internalType\": \"bool\",\"name\": \"approved\",\"type\": \"bool\"}],\"name\": \"setApprovalForAll\",\"outputs\": [],\"stateMutability\": \"nonpayable\",\"type\": \"function\"},{\"inputs\": [{\"internalType\": \"bytes4\",\"name\": \"interfaceId\",\"type\": \"bytes4\"}],\"name\": \"supportsInterface\",\"outputs\": [{\"internalType\": \"bool\",\"name\": \"\",\"type\": \"bool\"}],\"stateMutability\": \"view\",\"type\": \"function\"},{\"inputs\": [{\"internalType\": \"address\",\"name\": \"to\",\"type\": \"address\"},{\"internalType\": \"uint256\",\"name\": \"id\",\"type\": \"uint256\"},{\"internalType\": \"uint256\",\"name\": \"amount\",\"type\": \"uint256\"},{\"internalType\": \"string\",\"name\": \"traceInfo\",\"type\": \"string\"}],\"name\": \"transferArtNFT\",\"outputs\": [],\"stateMutability\": \"nonpayable\",\"type\": \"function\"},{\"inputs\": [{\"internalType\": \"uint256\",\"name\": \"\",\"type\": \"uint256\"}],\"name\": \"uri\",\"outputs\": [{\"internalType\": \"string\",\"name\": \"\",\"type\": \"string\"}],\"stateMutability\": \"view\",\"type\": \"function\"}]";

    /**
     * ERC1155合约部署，调用测试
     * @throws Exception 
     */
    @Test
    public void testERC1155() throws Exception {
    	
        // 手续费，可以固定设置一个较大的值，保证交易能成功，此处设置0.01个BTY
        long fee = 1000000;
    	
    	// =======> 为用户A和B生成私钥和地址
    	AccountInfo infoA = createAccount();
    	useraAddress = infoA.getAddress();
    	useraPrivateKey = infoA.getPrivateKey();
    	
    	AccountInfo infoB = createAccount();
    	userbAddress = infoB.getAddress();
    	userbPrivateKey = infoB.getPrivateKey();
    	
    	// =======>  通过管理员部署合约
        // 部署合约, 参数： 平行链合约名， 签名地址，签名私钥
        String hash = deployContract(paraName, managerAddress, managerPrivateKey);
        
        // 计算上一步部署到链上的合约地址
        String contractAddress = TransactionUtil.convertExectoAddr(managerAddress + hash.substring(2));
        System.out.println("部署好的合约地址 = " + contractAddress);
        
        // =======>  调用合约发行NFT,假设为2件游戏道具各生成100个NFT资产, id从10000开始
        int lenght = 2;
        int[] ids = new int[lenght];
        int[] amounts = new int[lenght];
        for (int i = 0; i < lenght; i++) {
        	ids[i] = 10000 + i;
        	amounts[i] = 100;
        }
        // 构造合约调用, mint对应solidity合约里的方法名， useraAddress, ids, amounts这三项对应合约里的参数。  将NFT发行在用户A地址下
        byte[] initNFT = EvmUtil.encodeParameter(abi, "mint", useraAddress, ids, amounts);

        hash = callContract(initNFT, contractAddress, managerAddress, managerPrivateKey, paraName, fee);
        
        // =======>  查询用户A地址下的余额
        byte[] packAbiGet = EvmUtil.encodeParameter(abi, "balanceOf", useraAddress, ids[0]);
        queryContract(packAbiGet, contractAddress, "转账前用户A,NFTID=" + ids[0] + "余额");
        
        packAbiGet = EvmUtil.encodeParameter(abi, "balanceOf", useraAddress, ids[1]);
        queryContract(packAbiGet, contractAddress, "转账前用户A,NFTID=" + ids[1] + "余额");
        
        // =======>  从A地址向B地址转账,使用代扣交易
        // 代扣交易需要对平行链合约地址做一个处理
        String execer = paraName + "evm";
        // 平行链合约地址计算(平行链title前缀+合约名称)
        String paracontractAddress = client.convertExectoAddr(execer);
        // 用户A将第1个NFT中的50个转给用户B
        String traceInfo = "用户A在2022年03月01日转赠50个NFT给用户B，在区块链上留证";
    	byte[] transfer = EvmUtil.encodeParameter(abi, "transferArtNFT", userbAddress, ids[0], 50, traceInfo);
    	// 构造转账交易体，先用用户A对此笔交易签名，
    	String txEncode = EvmUtil.callEvmContractWithhold(transfer,"", 0, execer, useraPrivateKey, contractAddress);
    	// 再调用代扣交易方法，用代扣私钥对交易组做签名
    	createNobalance(txEncode, paracontractAddress, useraPrivateKey, withholdPrivateKey);

        
        // =======>  查询用户A和用户B地址下的余额
        packAbiGet = EvmUtil.encodeParameter(abi, "balanceOf", useraAddress, ids[0]);
        queryContract(packAbiGet, contractAddress, "转账后用户A,NFTID=" + ids[0] + "余额");
        
        packAbiGet = EvmUtil.encodeParameter(abi, "balanceOf", userbAddress, ids[0]);
        queryContract(packAbiGet, contractAddress, "转账后用户B,NFTID=" + ids[0] + "余额");
        
        // =======>  查询溯源信息
        packAbiGet = EvmUtil.encodeParameter(abi, "getNFTTrace", String.valueOf(ids[0]));
        queryContractString(packAbiGet, contractAddress, "溯源信息");
    }
    
    /**
     * Step1: 生成私钥，地址
     * 一般在用户注册时调用，生成后在数据库中和用户信息绑定，后续直接从库中查出来使用
     */
    private AccountInfo createAccount() {
    	Account account = new Account();
		AccountInfo accountInfo = account.newAccountLocal();
		return accountInfo;
    }
    
    /**
     * Step2:部署合约
     * @throws Exception
     */
    private String deployContract(String execer, String address, String privateKey) throws Exception {

        // 部署合约
        String txEncode;
        String txhash = "";
        QueryTransactionResult txResult = new QueryTransactionResult();
        
        byte[] code = ByteUtil.merge(HexUtil.fromHexString(codes), abi.getBytes());
        
    	// TODO: 估算合约GAS费， 实际应用过程中，不建议在业务代码中直接调用gas费， 只是做预估使用。  实际可以在代码里设置一个大于这个值的数
        String evmCode = EvmUtil.getCreateEvmEncode(code, "", "deploy ERC1155 contract", execer);
        long gas = client.queryEVMGas("evm", evmCode, address);
        System.out.println("Gas fee is:" + gas);
        
        // 通过合约code, 管理员私钥，平行链名称+evm,手续费等参数构造部署合约交易，并签名
        txEncode = EvmUtil.createEvmContract(code, "", "evm-sdk-test", privateKey, execer, gas);
        // 将构造并签好名的交易通过rpc接口发送到平行链上
        txhash = client.submitTransaction(txEncode);
        System.out.println("部署合约交易hash = " + txhash);
        
        // BTY平均3-5秒一个区块确认， 需要延时去查结果
        Thread.sleep(5000);
		for (int tick = 0; tick < 10; tick++){
			txResult = client.queryTransaction(txhash);
			if(txResult == null) {
				Thread.sleep(1000);
				continue;
			}			
			break;
		}
		
		if ("ExecOk".equals(txResult.getReceipt().getTyname())) {
			System.out.println("合约部署成功");

		} else {
			System.out.println("合约部署失败，一般失败原因可能是因为地址下手续费不够");
		}
		
		return txhash;
    }
    
    /**
     * Step3: 调用合约
     * @param contractAddr
     * @param address
     * @param privateKey
     * @throws IOException 
     * @throws InterruptedException 
     */
    private String callContract(byte[] code, String contractAddr, String address, String privateKey, String execer, long gas) throws Exception {
    	
        // 调用合约
        String txEncode;
        String txhash = "";
        QueryTransactionResult txResult = new QueryTransactionResult();
    	
    	txEncode = EvmUtil.callEvmContract(code,"", 0, contractAddr, privateKey, execer, gas);
        txhash = client.submitTransaction(txEncode);
        System.out.println("调用合约hash = " + txhash);
        
        // BTY平均3-5秒一个区块确认， 需要延时去查结果
        Thread.sleep(5000);
		for (int tick = 0; tick < 10; tick++){
			txResult = client.queryTransaction(txhash);
			if(txResult == null) {
				Thread.sleep(1000);
				continue;
			}			
			break;
		}
		
		if ("ExecOk".equals(txResult.getReceipt().getTyname())) {
			System.out.println("合约调用成功");
			
		} else {
			System.out.println("合约调用失败，一般失败原因可能是因为地址下手续费不够");
		}
		
		return txhash;
    	
    }
    
    /**
     * 查询方法
     * @param queryAbi
     * @param contractAddress
     * @throws Exception 
     */
    private void queryContract(byte[] queryAbi, String contractAddress, String title) throws Exception {
        // 查询用户A和用户B地址下的资产余额
        JSONObject query = client.callEVMAbi(contractAddress, HexUtil.toHexString(queryAbi));
        JSONObject output = query.getJSONObject("result");
        String rawData = output.getString("rawData");
        System.out.println(title + ": " + HexUtil.hexStringToAlgorism(HexUtil.removeHexHeader(rawData)));
    }
    
    /**
     * 查询方法
     * @param queryAbi
     * @param contractAddress
     * @throws Exception 
     */
    private void queryContractString(byte[] queryAbi, String contractAddress, String title) throws Exception {
        // 查询用户A和用户B地址下的资产余额
        JSONObject query = client.callEVMAbi(contractAddress, HexUtil.toHexString(queryAbi));
        JSONObject output = query.getJSONObject("result");
        String rawData = output.getString("rawData");
        System.out.println(title + ": " + HexUtil.hexStringToString(HexUtil.removeHexHeader(rawData)));
    }
    
    
    /**
     * 构建代扣手续费交易
     * 
     * @param txEncode
     * @param contranctAddress
     * @return
     * @throws InterruptedException
     * @throws IOException 
     */
    private String createNobalance(String txEncode, String contranctAddress, String userPrivatekey, String withHoldPrivateKey) throws Exception {
        String createNoBalanceTx = client.createNoBalanceTx(txEncode, "");
	    // 解析交易
	    List<DecodeRawTransaction> decodeRawTransactions = client.decodeRawTransaction(createNoBalanceTx);
	    
	    String hexString = TransactionUtil.signDecodeTx(decodeRawTransactions, contranctAddress, userPrivatekey, withHoldPrivateKey);
	    String submitTransaction = client.submitTransaction(hexString);
	    System.out.println("代扣hash= " + submitTransaction);
	    
	    String nextString = null;
        QueryTransactionResult txResult = new QueryTransactionResult();

		Thread.sleep(5000);
		for (int tick = 0; tick < 10; tick++){
			QueryTransactionResult result = client.queryTransaction(submitTransaction);
			if(result == null) {
				Thread.sleep(1000);
				continue;
			}

			System.out.println("next:" + result.getTx().getNext());
			QueryTransactionResult nextResult = client.queryTransaction(result.getTx().getNext());
			System.out.println("ty:" + nextResult.getReceipt().getTyname());
			nextString = result.getTx().getNext();
			break;
		}
		
		
		txResult = client.queryTransaction(nextString);
		if ("ExecOk".equals(txResult.getReceipt().getTyname())) {
			System.out.println("合约调用成功");
			
		} else {
			System.out.println("合约调用失败，一般失败原因可能是因为地址下手续费不够");
		}
		return nextString;
    }
    
}
